<!DOCTYPE html>
<html>
<head>
  <title>石川中継タイマー</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 40px; }
    .timer-box {
      border: 1px solid #ccc; margin: 20px auto; padding: 10px; width: 900px; border-radius: 10px;
    }
    h2 { margin-bottom: 10px; }
    input, button { font-size: 30px; margin: 5px; padding: 5px 10px; }
    input[type="number"] { width: 150px; text-align: right; }
    .display-time {
      font-size: 140px;
      font-weight: bold;
      color: #f94903;
      margin-bottom: 15px;
    }
    button {
      background-color: #5485bc;
      color: #ffffff;
      font-weight: bold;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #333333;
    }
  </style>
</head>
<body>
  <h1>石川中継タイマー</h1>
  <div id="timers"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAfWHKmXad82HBw0zU-8k1t5OGKP5zhAdA",
      authDomain: "timer-ishikawa.firebaseapp.com",
      databaseURL: "https://timer-ishikawa-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "timer-ishikawa",
      appId: "1:367450670827:web:a721a9f1484370ca8e20ae",
      measurementId: "G-E7G8PKG9BZ",
      messagingSenderId: "367450670827"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const intervals = {};
    const timerKeys = ["timer1", "timer2", "timer3", "timer4", "timer5", "timer6", "timer7"];
    const labels = [
      "商品時間", "①コメントポーズ", "②コメントポーズ", "③コメントポーズ",
      "リキャップまで", "APCまで", "次セグスタートまで"
    ];

    const container = document.getElementById("timers");

    labels.forEach((label, i) => {
      const name = timerKeys[i];
      const box = document.createElement("div");
      box.className = "timer-box";
      box.innerHTML = `
        <h2>${label}</h2>
        <div id="display${i}" class="display-time">--:--:--</div>
        <input type="number" id="h${i}" min="0" value="0"> h
        <input type="number" id="m${i}" min="0" max="59" value="0"> m
        <input type="number" id="s${i}" min="0" max="59" value="0"> s <br/>
        <button onclick="startTimer('${name}', ${i})">スタート</button>
        <button onclick="resetTimer('${name}', ${i})">リセット</button>
      `;
      container.appendChild(box);

      const timerRef = ref(db, "sharedTimers/" + name);
      onValue(timerRef, (snapshot) => {
        const data = snapshot.val();
        if (data && data.endAt && data.running) {
          if (intervals[name]) clearInterval(intervals[name]);

          intervals[name] = setInterval(() => {
            const now = Math.floor(Date.now() / 1000);
            const remaining = data.endAt - now;
            if (remaining < 0) {
              document.getElementById("display" + i).innerText = "0:00:00";
              clearInterval(intervals[name]);
              return;
            }
            document.getElementById("display" + i).innerText = formatTime(remaining);
          }, 1000);
        } else {
          document.getElementById("display" + i).innerText = "0:00:00";
        }
      });
    });

    window.startTimer = function(name, i) {
      const h = parseInt(document.getElementById("h" + i).value) || 0;
      const m = parseInt(document.getElementById("m" + i).value) || 0;
      const s = parseInt(document.getElementById("s" + i).value) || 0;
      const totalSeconds = h * 3600 + m * 60 + s;
      const endAt = Math.floor(Date.now() / 1000) + totalSeconds;
      const timerRef = ref(db, "sharedTimers/" + name);
      set(timerRef, { endAt: endAt, running: true });
    };

    window.resetTimer = function(name, i) {
      const timerRef = ref(db, "sharedTimers/" + name);
      set(timerRef, { endAt: 0, running: false });
      document.getElementById("display" + i).innerText = "0:00:00";
      clearInterval(intervals[name]);
    };

    function formatTime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return `${h}:${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    }
  </script>
</body>
</html>
